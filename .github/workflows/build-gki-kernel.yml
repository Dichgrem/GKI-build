name: Build Android GKI Kernel

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: "Enable susfs support"
        required: false
        default: "true"
        type: boolean
      config_source:
        description: "Choose config source for myconfig"
        required: true
        default: "repo"
        type: choice
        options:
          - repo
      root_solution:
        description: "Choose root solution to integrate"
        required: false
        default: "sukisu"
        type: choice
        options:
          - sukisu
          - kernelsu
          - kernelsu-next
          - none
      kernel_name:
        description: "Custom kernel name (optional)"
        required: false
        default: "GKI"
        type: string

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      WORKDIR: ${{ github.workspace }}/kernel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential cpio curl flex \
            git libncurses-dev libssl-dev \
            libelf-dev lzop python3 unzip xz-utils \
            zstd rsync ca-certificates wget \
            pahole dwarves zip gcc g++
          gcc --version

      - name: Setup toolchains & directories
        run: |
          set -e
          echo "WORKDIR=$WORKDIR"
          mkdir -p "$WORKDIR"
          cd "$WORKDIR"

          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p clang-r547379
          mkdir -p anykernel3
          mkdir -p output

          # ä¸‹è½½ Clang å·¥å…·é“¾
          echo "=== Downloading Clang toolchain ==="
          curl -LO https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r547379.tar.gz
          tar -xzf clang-r547379.tar.gz -C clang-r547379
          rm clang-r547379.tar.gz

          # å…‹éš† GCC å·¥å…·é“¾
          echo "=== Cloning GCC toolchains ==="
          git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9 --depth=1
          git clone https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9 --depth=1

          echo "âœ… Setup toolchains -> OK"

      - name: Setup & Clone Kernel
        run: |
          set -e
          mkdir -p "$WORKDIR"
          cd "$WORKDIR"

          # å…‹éš†å†…æ ¸æºç 
          echo "ğŸ‘‰ Cloning kernel source"
          rm -rf android_kernel_oneplus_sm8650
          git clone --depth=1 https://github.com/OPACE3PRO/android_kernel_oneplus_sm8650.git android_kernel_oneplus_sm8650

          # å…‹éš†æ¨¡å—æºç 
          echo "ğŸ‘‰ Cloning sm8650-modules"
          rm -rf sm8650-modules
          git clone --depth=1 https://github.com/OPACE3PRO/android_kernel_oneplus_sm8650-modules.git sm8650-modules

          echo "âœ… Kernel source cloned -> android_kernel_oneplus_sm8650"
          echo "âœ… Modules cloned -> sm8650-modules"
          echo "=== Directory setup complete ==="
          ls -la "$WORKDIR"
          
          # è®¾ç½® KERNEL_DIR ç¯å¢ƒå˜é‡
          echo "KERNEL_DIR=android_kernel_oneplus_sm8650" >> $GITHUB_ENV

      - name: Show final WORKDIR layout
        run: |
          set -e
          cd "$WORKDIR"
          echo "Final layout under $WORKDIR:"
          ls -la

    #  - name: Clone AnyKernel3
    #    run: |
    #      cd $GITHUB_WORKSPACE/kernel
    #      git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ./anykernel3
    #      cd $GITHUB_WORKSPACE/kernel
    #      # ä½¿ç”¨aarch64ç»„ä»¶
    #      git clone --depth=1 --branch arm64-tools https://github.com/osm0sis/AnyKernel3.git anykernel3-tools
    #      cp -f ./anykernel3-tools/* anykernel3/tools/
    #      echo "=== AnyKernel3 ç›®å½•ç»“æ„ ==="
    #      ls -la ./anykernel3/

      - name: Copy and configure kernel config
        run: |
          set -euo pipefail
          echo "WORKDIR=$WORKDIR"
          if [ -z "${KERNEL_DIR:-}" ]; then
            echo "KERNEL_DIR is not set. Ensure previous step set it."
            exit 1
          fi

          SRC="$GITHUB_WORKSPACE/config/config_corvette"
          KERNEL_PATH="$WORKDIR/$KERNEL_DIR"
          TARGET_DIR="$KERNEL_PATH/arch/arm64/configs"
          TARGET="$TARGET_DIR/config_defconfig"

          echo "Copying $SRC -> $TARGET"
          if [ ! -f "$SRC" ]; then
            echo "âŒ Source config not found: $SRC"
            exit 1
          fi

          mkdir -p "$TARGET_DIR"
          cp -f "$SRC" "$TARGET"

          # æ ¡éªŒç›®æ ‡å­˜åœ¨ä¸”éç©º
          if [ -s "$TARGET" ]; then
            echo "âœ… OK: $TARGET exists and is non-empty"
            ls -la "$TARGET"
          else
            echo "âŒ Error: $TARGET missing or empty"
            exit 1
          fi


      - name: Install root solution
        run: |
          cd "$WORKDIR/$KERNEL_DIR"
          export KCONFIG_CONFIG="$PWD/arch/arm64/configs/config_defconfig"

          echo "ğŸ‘‰ é€‰æ‹©çš„ Root æ–¹æ¡ˆï¼š${{ github.event.inputs.root_solution }}"
          case "${{ github.event.inputs.root_solution }}" in
            kernelsu)
              echo "âœ… é›†æˆ KernelSU"
              curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -
              echo "ROOT_SUFFIX=_KernelSU" >> $GITHUB_ENV
              ;;
            kernelsu-next)
              echo "âœ… é›†æˆ KernelSU-Next"
              curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -
              echo "ROOT_SUFFIX=_KernelSU-Next" >> $GITHUB_ENV
              ;;
            sukisu)
              echo "âœ… é›†æˆ SukiSU-Ultra"
              curl -LSs https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh | bash -s main
              echo "ROOT_SUFFIX=_SukiSU" >> $GITHUB_ENV
              ;;
            none)
              echo "â„¹ï¸ æœªé€‰æ‹©ä»»ä½• Root æ–¹æ¡ˆï¼Œè·³è¿‡"
              ;;
            *)
              echo "âŒ æœªçŸ¥çš„ root_solution: ${{ github.event.inputs.root_solution }}" >&2
              exit 1
              ;;
          esac


    #  - name: Susfs patch
    #    run: |
    #      cd $GITHUB_WORKSPACE/kernel/source/$KERNEL_DIR

    #      if [ "${{ inputs.enable_susfs }}" = "true" ]; then
    #        # è·å–å†…æ ¸ç‰ˆæœ¬ï¼Œä¾‹å¦‚ "6.1.130"
    #        KERNEL_VER=$(make kernelversion)
    #        echo "ğŸ” Detected kernel version: $KERNEL_VER"

    #        # æå–ä¸»ç‰ˆæœ¬å’Œæ¬¡ç‰ˆæœ¬ï¼Œç”Ÿæˆåˆ†æ”¯å
    #        KERNEL_MAJOR=$(echo "$KERNEL_VER" | cut -d. -f1)
    #        KERNEL_MINOR=$(echo "$KERNEL_VER" | cut -d. -f2)

    #        # è‡ªåŠ¨æ¨æµ‹ Android ç‰ˆæœ¬ï¼ˆä½ å¯ä»¥æ”¹ä¸ºç¡¬ç¼–ç æ˜ å°„è¡¨ä»¥æ›´ä¸¥è°¨ï¼‰
    #        if [ "$KERNEL_MAJOR" = "6" ] && [ "$KERNEL_MINOR" = "1" ]; then
    #          SUSFS_BRANCH="gki-android14-6.1"
    #          SUSFS_PATCH="50_add_susfs_in_gki-android14-6.1.patch"
    #        elif [ "$KERNEL_MAJOR" = "5" ] && [ "$KERNEL_MINOR" = "15" ]; then
    #          SUSFS_BRANCH="gki-android14-5.15"
    #          SUSFS_PATCH="50_add_susfs_in_gki-android14-5.15.patch"
    #        elif [ "$KERNEL_MAJOR" = "5" ] && [ "$KERNEL_MINOR" = "10" ]; then
    #          SUSFS_BRANCH="gki-android13-5.10"
    #          SUSFS_PATCH="50_add_susfs_in_gki-android13-5.10.patch"
    #        else
    #          echo "âŒ Unsupported kernel version: $KERNEL_VER"
    #          exit 1
    #        fi

    #        echo "ğŸŒ¿ Cloning susfs4ksu branch: $SUSFS_BRANCH"
    #        git clone https://gitlab.com/simonpunk/susfs4ksu.git
    #        cd susfs4ksu
    #        git switch $SUSFS_BRANCH || { echo "âŒ Failed to switch to branch $SUSFS_BRANCH"; exit 1; }
    #        cd ..

    #        echo "ğŸ“ Copying susfs source and headers"
    #        cp susfs4ksu/kernel_patches/fs/* fs/
    #        cp susfs4ksu/kernel_patches/include/linux/* include/linux/

    #        echo "ğŸ“¦ Applying patch: $SUSFS_PATCH"
    #        cp susfs4ksu/kernel_patches/$SUSFS_PATCH .
    #        patch -p1 < $SUSFS_PATCH || { echo "âŒ Failed to apply patch: $SUSFS_PATCH"; exit 1; }

    #       echo "âœ… Susfs patch applied successfully"
    #      else
    #        echo "â„¹ï¸ æœªå¯ç”¨ Susfsï¼Œè·³è¿‡è¡¥ä¸æ­¥éª¤"
    #      fi

      - name: Build kernel
        run: |
          set -euo pipefail
          cd "$WORKDIR/$KERNEL_DIR"
          echo "=== Build start ==="
          starttime=$(date +'%Y-%m-%d %H:%M:%S')
          echo "Build started at: $starttime"
          
          # åŸºæœ¬å˜é‡
          export ARCH=arm64
          export SUBARCH=arm64
          export OUT=out
          export KERNEL_DEFCONFIG=config_defconfig

          # é»˜è®¤ LTO ä¸º thin
          export LTO="${LTO:-thin}"
          echo "LTO mode: $LTO"

          # å·¥å…·é“¾è·¯å¾„
          export CLANG_PATH="$WORKDIR/clang-r547379"
          export GCC64_PATH="$WORKDIR/aarch64-linux-android-4.9"
          export GCC32_PATH="$WORKDIR/arm-linux-androideabi-4.9"

          # å°†å·¥å…·é“¾åŠ å…¥ PATH
          export PATH="${CLANG_PATH}/bin:${GCC64_PATH}/bin:${GCC32_PATH}/bin:${PATH}"

          # CLANG stack frame limit
          export CLANG_MAX_STACK_SIZE=8192
          export KCFLAGS="-Wno-error=frame-larger-than"

          echo "Using CLANG_PATH=$CLANG_PATH"
          which clang || true
          clang --version || true

          # æ¸…ç†è¾“å‡ºç›®å½•
          rm -rf "$OUT" && mkdir -p "$OUT"

          # 1) ç”Ÿæˆ defconfig
          echo "=== make O=${OUT} ${KERNEL_DEFCONFIG} ==="
          make O=${OUT} ARCH=${ARCH} ${KERNEL_DEFCONFIG}
          if [ $? -ne 0 ]; then
            echo "âŒ make ${KERNEL_DEFCONFIG} failed"
            exit 1
          fi

          # 2) å¤„ç† LTO (none/thin/full)
          if [ "${LTO}" = "none" ] || [ "${LTO}" = "thin" ] || [ "${LTO}" = "full" ]; then
            echo "Applying LTO=${LTO} to ${OUT}/.config"
            if [ "${LTO}" = "none" ]; then
              scripts/config --file ${OUT}/.config -d LTO_CLANG -e LTO_NONE -d LTO_CLANG_THIN -d LTO_CLANG_FULL -d THINLTO
            elif [ "${LTO}" = "thin" ]; then
              scripts/config --file ${OUT}/.config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
            else
              scripts/config --file ${OUT}/.config -e LTO_CLANG -d LTO_NONE -d LTO_CLANG_THIN -e LTO_CLANG_FULL -d THINLTO
            fi
            grep -E "LTO_CLANG|LTO_NONE|LTO_CLANG_THIN|LTO_CLANG_FULL|THINLTO" ${OUT}/.config || true
          else
            echo "Invalid LTO value: ${LTO}. Use none|thin|full."
            exit 1
          fi

          # 3) æ„å»ºå‚æ•°
          TH_COUNT=$(nproc)
          echo "Using ${TH_COUNT} parallel jobs"
          DEF_ARGS="O=${OUT} \
          ARCH=${ARCH} \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
          CC=${CLANG_PATH}/bin/clang \
          AR=${CLANG_PATH}/bin/llvm-ar \
          NM=${CLANG_PATH}/bin/llvm-nm \
          LD=${CLANG_PATH}/bin/ld.lld \
          HOSTCC=${CLANG_PATH}/bin/clang \
          HOSTCXX=${CLANG_PATH}/bin/clang++ \
          OBJCOPY=${CLANG_PATH}/bin/llvm-objcopy \
          OBJDUMP=${CLANG_PATH}/bin/llvm-objdump \
          READELF=${CLANG_PATH}/bin/llvm-readelf \
          OBJSIZE=${CLANG_PATH}/bin/llvm-size \
          STRIP=${CLANG_PATH}/bin/llvm-strip \
          LLVM_IAS=1 \
          LLVM=1 \
          KCFLAGS=\"${KCFLAGS}\""

          BUILD_ARGS="-j${TH_COUNT} ${DEF_ARGS}"

          echo "=== Start make (logging to ${OUT}/error.log) ==="
          chmod -R 777 *
          rm android/abi_gki_protected_exports_* || true
          make ${BUILD_ARGS} 2>&1 | tee ${OUT}/error.log || true

          echo "=== Tail of build log ==="
          tail -n 200 ${OUT}/error.log || true

          endtime=$(date +'%Y-%m-%d %H:%M:%S')
          echo "Build started at: $starttime"
          echo "Build finished at: $endtime"
          echo "=== Build step finished (check out/error.log for full log) ==="

      - name: Check build results
        run: |
          set -euo pipefail
          cd "$WORKDIR/$KERNEL_DIR"
          echo "=== Build Results ==="
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "âœ… Kernel build successful!"
            ls -la out/arch/arm64/boot/
            ls -la out/vmlinux || true
            du -h out/arch/arm64/boot/Image || true
          else
            echo "âŒ Kernel build failed!"
            echo "=== Last 200 lines of error log ==="
            if [ -f out/error.log ]; then
              tail -n 200 out/error.log
              echo "=== Error summary (last 20 matching lines) ==="
              grep -iE "error|failed|stop" out/error.log | tail -20 || true
            else
              echo "No out/error.log found"
            fi
            exit 1
          fi

      # - name: Prepare AnyKernel3 package
      #   run: |
      #     cd $GITHUB_WORKSPACE/kernel

      #     # è®¾ç½®å†…æ ¸åç§°
      #     KERNEL_NAME="${{ inputs.kernel_name }}"
      #     if [ -z "$KERNEL_NAME" ]; then
      #       KERNEL_NAME="CustomKernel"
      #     fi

      #     # è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
      #     cd source/$KERNEL_DIR
      #     KERNEL_VERSION=$(make kernelversion 2>/dev/null || echo "unknown")
      #     BUILD_DATE=$(date +'%Y%m%d_%H%M')

      #     cd $GITHUB_WORKSPACE/kernel

      #     echo "=== å‡†å¤‡ AnyKernel3 æ‰“åŒ… ==="
      #     echo "å†…æ ¸åç§°: $KERNEL_NAME"
      #     echo "å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
      #     echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
      #     echo "ç›®æ ‡è®¾å¤‡: $DEVICE_NAME ($DEVICE_CODENAME)"
      #     echo "SoCå¹³å°: $SOC_PLATFORM"

      #     # å¤åˆ¶ AnyKernel3 æ¨¡æ¿åˆ°è¾“å‡ºç›®å½•
      #     cp -r anykernel3/* output/

      #     # å¤åˆ¶å†…æ ¸æ–‡ä»¶
      #     cp source/$KERNEL_DIR/out/arch/arm64/boot/Image output/

      #     # ä¿®æ”¹ AnyKernel3 é…ç½®
      #     cd output && rm -rf ramdisk patch modules

      #     # åˆ›å»ºæ›´æ–°ä¿¡æ¯æ–‡ä»¶
      #     cat > kernel_info.txt << EOF
      #     Kernel Name: $KERNEL_NAME
      #     Kernel Version: $KERNEL_VERSION
      #     Build Date: $BUILD_DATE
      #     Target Device: $DEVICE_NAME ($DEVICE_CODENAME)
      #     SoC Platform: $SOC_PLATFORM
      #     BBR Enabled: ${{ inputs.enable_bbr }}
      #     ZRAM Enabled: ${{ inputs.enable_zram }}
      #     ZRAM Algorithm: ${{ inputs.zram_algorithm }}
      #     Root Solution: ${{ inputs.root_solution }}
      #     Compiler: Clang 21.0.0
      #     Architecture: ARM64
      #     EOF

      #     echo "=== AnyKernel3 å‡†å¤‡å®Œæˆ ==="
      #     ls -la ./

      # - name: Create AnyKernel3 ZIP package
      #   run: |
      #     cd $GITHUB_WORKSPACE/kernel/output

      #     # è®¾ç½®åŒ…å
      #     KERNEL_NAME="${{ inputs.kernel_name }}"
      #     if [ -z "$KERNEL_NAME" ]; then
      #       KERNEL_NAME="CustomKernel"
      #     fi

      #     BUILD_DATE=$(date +'%Y%m%d_%H%M')
      #     BBR_SUFFIX=""
      #     if [ "${{ inputs.enable_bbr }}" = "true" ]; then
      #       BBR_SUFFIX="_BBR"
      #     fi

      #     SUSFS_NAME=""
      #     if [ "${{ inputs.enable_susfs }}" = "true" ]; then
      #       BBR_SUFFIX="_Susfs"
      #     fi

      #     ZIP_NAME="${KERNEL_NAME}_${DEVICE_CODENAME}${BBR_SUFFIX}${ROOT_SUFFIX}${SUSFS_NAME}_${BUILD_DATE}.zip"

      #     echo "=== åˆ›å»º ZIP åŒ…: $ZIP_NAME ==="

      #     # åˆ›å»º ZIP åŒ…
      #     zip -r9 "$ZIP_NAME" . -x "*.bak" "*.zip"

      #     # éªŒè¯ ZIP åŒ…
      #     if [ -f "$ZIP_NAME" ]; then
      #       echo "âœ… ZIP åŒ…åˆ›å»ºæˆåŠŸ!"
      #       echo "åŒ…å: $ZIP_NAME"
      #       echo "å¤§å°: $(du -h "$ZIP_NAME")"

      #       # æ˜¾ç¤º ZIP åŒ…å†…å®¹
      #       echo "=== ZIP åŒ…å†…å®¹ ==="
      #       unzip -l "$ZIP_NAME" | head -20
      #     else
      #       echo "âŒ ZIP åŒ…åˆ›å»ºå¤±è´¥!"
      #       exit 1
      #     fi

      #     # ä¿å­˜åŒ…åä¾›åç»­æ­¥éª¤ä½¿ç”¨
      #     echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-build-${{ github.run_number }}
          path: |
            # å†…æ ¸ Image
            ${{ github.workspace }}/kernel/${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image*
            # Device Tree Blob
            ${{ github.workspace }}/kernel/${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dts/*/*.dtb
            # ç¼–è¯‘æ—¥å¿—
            ${{ github.workspace }}/kernel/${{ env.KERNEL_DIR }}/out/error.log
            # æœ€ç»ˆé…ç½®æ–‡ä»¶
            ${{ github.workspace }}/kernel/${{ env.KERNEL_DIR }}/out/.config
            # ä»»ä½•ç”Ÿæˆçš„ zip åŒ…
            ${{ github.workspace }}/kernel/output/*.zip
            # Kernel ä¿¡æ¯æ–‡ä»¶
            ${{ github.workspace }}/kernel/output/kernel_info.txt


      # - name: Upload AnyKernel3 ZIP
      #   uses: actions/upload-artifact@v4
      #   if: success()
      #   with:
      #     name: ${{ env.ZIP_NAME }}
      #     path: kernel/output/${{ env.ZIP_NAME }}
      #     retention-days: 25