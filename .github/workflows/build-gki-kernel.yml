name: Build Android GKI Kernel

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: "Enable susfs support"
        required: false
        default: "true"
        type: boolean
      device:
        description: "Target OnePlus device"
        required: true
        default: "corvette"
        type: choice
        options:
          - corvette
      config_source:
        description: "Choose config source for myconfig"
        required: true
        default: "repo"
        type: choice
        options:
          - repo
          - default
      root_solution:
        description: "Choose root solution to integrate"
        required: false
        default: "sukisu"
        type: choice
        options:
          - sukisu
          - kernelsu
          - kernelsu-next
          - none
      kernel_name:
        description: "Custom kernel name (optional)"
        required: false
        default: "GKI"
        type: string

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      WORKDIR: ${{ github.workspace }}/kernel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential cpio curl flex \
            git libncurses-dev libssl-dev \
            libelf-dev lzop python3 unzip xz-utils \
            zstd rsync ca-certificates wget \
            pahole dwarves zip gcc g++
          gcc --version

      - name: Setup directory structure
        run: |
          set -e
          echo "WORKDIR=$WORKDIR"
          mkdir -p "$WORKDIR"
          cd "$WORKDIR"
          # ä¸æœ¬åœ°ä¸€è‡´
          mkdir -p aarch64-linux-android-4.9
          mkdir -p arm-linux-androideabi-4.9
          mkdir -p clang-r547379
          mkdir -p android_kernel_oneplus_sm8650
          mkdir -p sm8650-modules
          mkdir -p anykernel3
          mkdir -p output
          echo "=== Created directory structure under $WORKDIR ==="
          ls -la "$WORKDIR"

      - name: Setup toolchains
        run: |
          set -e
          cd "$WORKDIR"
          echo "=== Downloading and preparing clang-r547379 ==="
          wget -nv -O clang-r547379.tar.gz "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz"
          # extract into clang-r547379, strip top-level if present
          mkdir -p clang-r547379
          tar -xvf clang-r547379.tar.gz -C clang-r547379 --strip-components=1
          echo "clang-r547379 contents:"
          ls -la clang-r547379 | sed -n '1,200p'

          echo "=== Cloning prebuilts GCC (aarch64 & arm) ==="
          if [ ! -d "aarch64-linux-android-4.9/.git" ]; then
            git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          else
            echo "aarch64 prebuilts already present"
          fi

          if [ ! -d "arm-linux-androideabi-4.9/.git" ]; then
            git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
          else
            echo "arm prebuilts already present"
          fi

          echo "Prebuilts aarch64 snapshot:"
          ls -la aarch64-linux-android-4.9 | sed -n '1,200p'
          echo "Prebuilts arm snapshot:"
          ls -la arm-linux-androideabi-4.9 | sed -n '1,200p'

      - name: Determine kernel repo & branch
        id: vars
        run: |
          set -e
          DEV="${{ github.event.inputs.device }}"
          case "$DEV" in
            corvette)
              REPO=https://github.com/OPACE3PRO/android_kernel_oneplus_sm8650.git
              DEVICE_CODENAME=corvette
              DEVICE_NAME="OnePlus ACE3 Pro"
              SOC_PLATFORM=sm8650
              KERNEL_DIR=android_kernel_oneplus_sm8650
              ;;
            *)
              echo "Unsupported device: $DEV"
              exit 1
              ;;
          esac
          echo "REPO=$REPO" >> $GITHUB_ENV
          echo "DEVICE_CODENAME=$DEVICE_CODENAME" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SOC_PLATFORM=$SOC_PLATFORM" >> $GITHUB_ENV
          echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV

          echo "=== Device Configuration ==="
          echo "Device: $DEVICE_NAME ($DEVICE_CODENAME)"
          echo "SoC Platform: $SOC_PLATFORM"
          echo "Repository: $REPO"
          echo "Kernel Directory: $KERNEL_DIR"

      - name: Clone Kernel source
        run: |
          set -e
          cd "$WORKDIR"
          # ä½¿ç”¨ä¸Šä¸€æ­¥å†™å…¥çš„ REPO ç¯å¢ƒå˜é‡
          REPO="${REPO:-}"
          if [ -z "$REPO" ]; then
            echo "REPO is not set"
            exit 1
          fi

          # detect default branch if BRANCH not provided
          if [ -z "${BRANCH}" ]; then
            echo "BRANCH not set; detecting remote default branch..."
            BRANCH=$(git ls-remote --symref "$REPO" HEAD | awk '/^ref:/ {sub("refs/heads/", "", $2); print $2; exit}')
            echo "Detected default branch: $BRANCH"
          fi

          echo "Cloning kernel repo ($REPO) branch: $BRANCH -> $WORKDIR/android_kernel_oneplus_sm8650"
          rm -rf android_kernel_oneplus_sm8650 || true
          git clone --depth=1 --branch "$BRANCH" "$REPO" android_kernel_oneplus_sm8650

          echo "Cloning modules repo (OPACE3PRO) -> $WORKDIR/sm8650-modules"
          if [ ! -d "sm8650-modules/.git" ]; then
            git clone --depth=1 https://github.com/OPACE3PRO/android_kernel_oneplus_sm8650-modules.git sm8650-modules
          else
            echo "sm8650-modules already exists"
          fi

          echo "Kernel top-level:"
          ls -la android_kernel_oneplus_sm8650 | sed -n '1,200p'
          echo "sm8650-modules remotes:"
          git -C sm8650-modules remote -v || true
          ls -la sm8650-modules | sed -n '1,200p'

      - name: Show final WORKDIR layout
        run: |
          set -e
          cd "$WORKDIR"
          echo "Final layout under $WORKDIR:"
          ls -la
          echo "Sample clang dir listing:"
          ls -la clang-r547379 | sed -n '1,200p'


      - name: Clone AnyKernel3
        run: |
          cd $GITHUB_WORKSPACE/kernel
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ./anykernel3
          cd $GITHUB_WORKSPACE/kernel
          # ä½¿ç”¨aarch64ç»„ä»¶
          git clone --depth=1 --branch arm64-tools https://github.com/osm0sis/AnyKernel3.git anykernel3-tools
          cp -f ./anykernel3-tools/* anykernel3/tools/
          echo "=== AnyKernel3 ç›®å½•ç»“æ„ ==="
          ls -la ./anykernel3/

      - name: Copy and configure kernel config
        run: |
          cd $GITHUB_WORKSPACE/kernel

          if [ "${{ github.event.inputs.config_source }}" = "repo" ]; then
            echo "ğŸ‘‰ ä½¿ç”¨ä»“åº“ config ç›®å½•ä¸‹çš„ config_${{ github.event.inputs.device }} ä½œä¸º myconfig"

            # æ£€æŸ¥å¯¹åº”è®¾å¤‡çš„é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            CONFIG_FILE="config/config_${{ github.event.inputs.device }}"
            if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
              echo "âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨"
              echo "å¯ç”¨çš„é…ç½®æ–‡ä»¶ï¼š"
              ls -la "$GITHUB_WORKSPACE/config/"
              exit 1
            fi

            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            cp "$GITHUB_WORKSPACE/$CONFIG_FILE" "source/$KERNEL_DIR/myconfig"

          else
            echo "ğŸ‘‰ ä½¿ç”¨æºç ä»“åº“çš„é»˜è®¤ arm64 defconfig ç”Ÿæˆ myconfig"
            cd source/$KERNEL_DIR

            # ä½¿ç”¨é»˜è®¤çš„ arm64 defconfig
            make O=out ARCH=arm64 defconfig

            # å°†ç”Ÿæˆçš„ .config é‡å‘½åä¸º myconfig
            cp out/.config myconfig

            # å›åˆ° kernel æ ¹ç›®å½•
            cd $GITHUB_WORKSPACE/kernel
          fi

          cd source/$KERNEL_DIR

          echo "=== Configuration Summary ==="
          echo "Device: $DEVICE_NAME ($DEVICE_CODENAME)"
          echo "SoC Platform: $SOC_PLATFORM"

      - name: Install root solution
        run: |
          cd $GITHUB_WORKSPACE/kernel/source/$KERNEL_DIR
          export KCONFIG_CONFIG=myconfig

          echo "ğŸ‘‰ é€‰æ‹©çš„ Root æ–¹æ¡ˆï¼š${{ github.event.inputs.root_solution }}"
          if [ "${{ github.event.inputs.root_solution }}" = "kernelsu" ]; then
            echo "âœ… é›†æˆ KernelSU"
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
            echo "ROOT_SUFFIX=_KernelSU" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.root_solution }}" = "kernelsu-next" ]; then
            echo "âœ… é›†æˆ KernelSU-Next"
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
            echo "ROOT_SUFFIX=_KernelSU-Next" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.root_solution }}" = "sukisu" ]; then
            echo "âœ… é›†æˆ SukiSU-Ultra"
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
            echo "ROOT_SUFFIX=_SukiSU" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.root_solution }}" = "none" ]; then
          echo "â„¹ï¸ æœªé€‰æ‹©ä»»ä½• Root æ–¹æ¡ˆï¼Œè·³è¿‡"
          else
            echo "âŒ æœªçŸ¥çš„ root_solution: ${{ github.event.inputs.root_solution }}"
            exit 1
          fi

      - name: Susfs patch
        run: |
          cd $GITHUB_WORKSPACE/kernel/source/$KERNEL_DIR

          if [ "${{ inputs.enable_susfs }}" = "true" ]; then
            # è·å–å†…æ ¸ç‰ˆæœ¬ï¼Œä¾‹å¦‚ "6.1.130"
            KERNEL_VER=$(make kernelversion)
            echo "ğŸ” Detected kernel version: $KERNEL_VER"

            # æå–ä¸»ç‰ˆæœ¬å’Œæ¬¡ç‰ˆæœ¬ï¼Œç”Ÿæˆåˆ†æ”¯å
            KERNEL_MAJOR=$(echo "$KERNEL_VER" | cut -d. -f1)
            KERNEL_MINOR=$(echo "$KERNEL_VER" | cut -d. -f2)

            # è‡ªåŠ¨æ¨æµ‹ Android ç‰ˆæœ¬ï¼ˆä½ å¯ä»¥æ”¹ä¸ºç¡¬ç¼–ç æ˜ å°„è¡¨ä»¥æ›´ä¸¥è°¨ï¼‰
            if [ "$KERNEL_MAJOR" = "6" ] && [ "$KERNEL_MINOR" = "1" ]; then
              SUSFS_BRANCH="gki-android14-6.1"
              SUSFS_PATCH="50_add_susfs_in_gki-android14-6.1.patch"
            elif [ "$KERNEL_MAJOR" = "5" ] && [ "$KERNEL_MINOR" = "15" ]; then
              SUSFS_BRANCH="gki-android14-5.15"
              SUSFS_PATCH="50_add_susfs_in_gki-android14-5.15.patch"
            elif [ "$KERNEL_MAJOR" = "5" ] && [ "$KERNEL_MINOR" = "10" ]; then
              SUSFS_BRANCH="gki-android13-5.10"
              SUSFS_PATCH="50_add_susfs_in_gki-android13-5.10.patch"
            else
              echo "âŒ Unsupported kernel version: $KERNEL_VER"
              exit 1
            fi

            echo "ğŸŒ¿ Cloning susfs4ksu branch: $SUSFS_BRANCH"
            git clone https://gitlab.com/simonpunk/susfs4ksu.git
            cd susfs4ksu
            git switch $SUSFS_BRANCH || { echo "âŒ Failed to switch to branch $SUSFS_BRANCH"; exit 1; }
            cd ..

            echo "ğŸ“ Copying susfs source and headers"
            cp susfs4ksu/kernel_patches/fs/* fs/
            cp susfs4ksu/kernel_patches/include/linux/* include/linux/

            echo "ğŸ“¦ Applying patch: $SUSFS_PATCH"
            cp susfs4ksu/kernel_patches/$SUSFS_PATCH .
            patch -p1 < $SUSFS_PATCH || { echo "âŒ Failed to apply patch: $SUSFS_PATCH"; exit 1; }

            echo "âœ… Susfs patch applied successfully"
          else
            echo "â„¹ï¸ æœªå¯ç”¨ Susfsï¼Œè·³è¿‡è¡¥ä¸æ­¥éª¤"
          fi

      - name: Build kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel/source/$KERNEL_DIR

          # è®°å½•å¼€å§‹æ—¶é—´
          starttime=$(date +'%Y-%m-%d %H:%M:%S')
          echo "Build started at: $starttime"
          echo "Building for: $DEVICE_NAME ($DEVICE_CODENAME) - $SOC_PLATFORM"

          # è®¾ç½®ç¯å¢ƒå˜é‡
          export ARCH=arm64
          export SUBARCH=arm64
          export KCONFIG_CONFIG=$PWD/myconfig

          # è®¾ç½®å·¥å…·é“¾è·¯å¾„å˜é‡
          export CLANG_PATH=$GITHUB_WORKSPACE/kernel/toolchains/clang-r487747c/bin
          export PATH=$CLANG_PATH:$PATH

          # éªŒè¯æ‰€æœ‰å¿…éœ€çš„å·¥å…·
          echo "=== éªŒè¯ç¼–è¯‘å™¨è·¯å¾„ ==="
          which clang
          clang --version
          echo "=== éªŒè¯ clang æ˜¯å¦æ”¯æŒ --target ==="
          clang --target=aarch64-linux-gnu -fsyntax-only -x c /dev/null || echo "âŒ clang ä¸æ”¯æŒ aarch64 ç›®æ ‡"
          echo "=== éªŒè¯ binutils æ˜¯å¦å¯ç”¨ ==="
          which llvm-objcopy
          which llvm-strip

          # æ¸…ç†æ„å»ºç›®å½•
          rm -rf out && mkdir -p out

          # ç”Ÿæˆé»˜è®¤é…ç½®
          make O=out KCONFIG_CONFIG=$KCONFIG_CONFIG olddefconfig

          # ç¼–è¯‘å†…æ ¸
          make -j$(nproc) O=out \
             LLVM=1 \
             WERROR=0 \
             KBUILD_NO_WERROR=1 \
             CC=clang \
             AR=llvm-ar \
             LD=ld.lld \
             NM=llvm-nm \
             OBJCOPY=llvm-objcopy \
             OBJDUMP=llvm-objdump \
             STRIP=llvm-strip \
             HOSTCC=clang \
             HOSTCXX=clang++ \
             CROSS_COMPILE= \
             CROSS_COMPILE_ARM32=arm-linux-androideabi- \
             KCFLAGS="--target=aarch64-linux-gnu -Wno-error" \
             KCPPFLAGS="-DCONFIG_CC_OPTIMIZE_FOR_PERFORMANCE" \
             HOSTCFLAGS="-Wno-error" \
             HOSTCXXFLAGS="-Wno-error" \
             2>&1 | tee out/error.log

          tail -n 100 out/error.log

          # è®°å½•ç»“æŸæ—¶é—´
          endtime=$(date +'%Y-%m-%d %H:%M:%S')
          echo "Build started at: $starttime"
          echo "Build finished at: $endtime"

      - name: Check build results
        run: |
          cd $GITHUB_WORKSPACE/kernel/source/$KERNEL_DIR
          echo "=== Build Results ==="
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "âœ… Kernel build successful!"
            ls -la out/arch/arm64/boot/
            ls -la out/vmlinux
            echo "Image size: $(du -h out/arch/arm64/boot/Image)" 
          else
            echo "âŒ Kernel build failed!"
            echo "=== Last 100 lines of error log ==="
            tail -100 out/error.log
            echo "=== Error summary ==="
            grep -i "error\|failed\|stop" out/error.log | tail -10
            exit 1
          fi

      - name: Prepare AnyKernel3 package
        run: |
          cd $GITHUB_WORKSPACE/kernel

          # è®¾ç½®å†…æ ¸åç§°
          KERNEL_NAME="${{ inputs.kernel_name }}"
          if [ -z "$KERNEL_NAME" ]; then
            KERNEL_NAME="CustomKernel"
          fi

          # è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          cd source/$KERNEL_DIR
          KERNEL_VERSION=$(make kernelversion 2>/dev/null || echo "unknown")
          BUILD_DATE=$(date +'%Y%m%d_%H%M')

          cd $GITHUB_WORKSPACE/kernel

          echo "=== å‡†å¤‡ AnyKernel3 æ‰“åŒ… ==="
          echo "å†…æ ¸åç§°: $KERNEL_NAME"
          echo "å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
          echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
          echo "ç›®æ ‡è®¾å¤‡: $DEVICE_NAME ($DEVICE_CODENAME)"
          echo "SoCå¹³å°: $SOC_PLATFORM"

          # å¤åˆ¶ AnyKernel3 æ¨¡æ¿åˆ°è¾“å‡ºç›®å½•
          cp -r anykernel3/* output/

          # å¤åˆ¶å†…æ ¸æ–‡ä»¶
          cp source/$KERNEL_DIR/out/arch/arm64/boot/Image output/

          # ä¿®æ”¹ AnyKernel3 é…ç½®
          cd output && rm -rf ramdisk patch modules

          # åˆ›å»ºæ›´æ–°ä¿¡æ¯æ–‡ä»¶
          cat > kernel_info.txt << EOF
          Kernel Name: $KERNEL_NAME
          Kernel Version: $KERNEL_VERSION
          Build Date: $BUILD_DATE
          Target Device: $DEVICE_NAME ($DEVICE_CODENAME)
          SoC Platform: $SOC_PLATFORM
          BBR Enabled: ${{ inputs.enable_bbr }}
          ZRAM Enabled: ${{ inputs.enable_zram }}
          ZRAM Algorithm: ${{ inputs.zram_algorithm }}
          Root Solution: ${{ inputs.root_solution }}
          Compiler: Clang 21.0.0
          Architecture: ARM64
          EOF

          echo "=== AnyKernel3 å‡†å¤‡å®Œæˆ ==="
          ls -la ./

      - name: Create AnyKernel3 ZIP package
        run: |
          cd $GITHUB_WORKSPACE/kernel/output

          # è®¾ç½®åŒ…å
          KERNEL_NAME="${{ inputs.kernel_name }}"
          if [ -z "$KERNEL_NAME" ]; then
            KERNEL_NAME="CustomKernel"
          fi

          BUILD_DATE=$(date +'%Y%m%d_%H%M')
          BBR_SUFFIX=""
          if [ "${{ inputs.enable_bbr }}" = "true" ]; then
            BBR_SUFFIX="_BBR"
          fi

          SUSFS_NAME=""
          if [ "${{ inputs.enable_susfs }}" = "true" ]; then
            BBR_SUFFIX="_Susfs"
          fi

          ZIP_NAME="${KERNEL_NAME}_${DEVICE_CODENAME}${BBR_SUFFIX}${ROOT_SUFFIX}${SUSFS_NAME}_${BUILD_DATE}.zip"

          echo "=== åˆ›å»º ZIP åŒ…: $ZIP_NAME ==="

          # åˆ›å»º ZIP åŒ…
          zip -r9 "$ZIP_NAME" . -x "*.bak" "*.zip"

          # éªŒè¯ ZIP åŒ…
          if [ -f "$ZIP_NAME" ]; then
            echo "âœ… ZIP åŒ…åˆ›å»ºæˆåŠŸ!"
            echo "åŒ…å: $ZIP_NAME"
            echo "å¤§å°: $(du -h "$ZIP_NAME")"

            # æ˜¾ç¤º ZIP åŒ…å†…å®¹
            echo "=== ZIP åŒ…å†…å®¹ ==="
            unzip -l "$ZIP_NAME" | head -20
          else
            echo "âŒ ZIP åŒ…åˆ›å»ºå¤±è´¥!"
            exit 1
          fi

          # ä¿å­˜åŒ…åä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Compress vmlinux
        if: always()
        run: |
          VMLINUX=kernel/source/${{ env.KERNEL_DIR }}/out/vmlinux
          if [ -f "$VMLINUX" ]; then
            echo "âœ… vmlinux exists, compressing..."
            gzip -c "$VMLINUX" > "${VMLINUX}.gz"
          else
            echo "âš ï¸ vmlinux not found, skipping compression"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-build-${{ env.DEVICE_CODENAME }}-${{ github.run_number }}
          path: |
            kernel/source/${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image*
            kernel/source/${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dts/*/*.dtb
            kernel/source/${{ env.KERNEL_DIR }}/out/vmlinux.gz
            kernel/source/${{ env.KERNEL_DIR }}/out/error.log
            kernel/source/${{ env.KERNEL_DIR }}/out/.config
            kernel/output/*.zip
            kernel/output/kernel_info.txt

      - name: Upload AnyKernel3 ZIP
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ env.ZIP_NAME }}
          path: kernel/output/${{ env.ZIP_NAME }}
          retention-days: 25
