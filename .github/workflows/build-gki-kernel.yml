name: Build Android GKI Kernel

on:
  workflow_dispatch:
    inputs:
      enable_bbr:
        description: "Enable BBR TCP Congestion Control"
        required: false
        default: "true"
        type: boolean
      enable_zram:
        description: "Enable ZRAM support"
        required: false
        default: "true"
        type: boolean
      zram_algorithm:
        description: "ZRAM compression algorithm"
        required: false
        default: "lz4"
        type: choice
        options:
          - lz4
          - zstd
      root_solution:
        description: "Choose root solution to integrate"
        required: false
        default: "sukisu"
        type: choice
        options:
          - sukisu
          - kernelsu
          - kernelsu-next
          - none
      kernel_name:
        description: "Custom kernel name (optional)"
        required: false
        default: "GKI"
        type: string

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies and update GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential cpio curl flex \
            git libncurses-dev libssl-dev \
            libelf-dev lzop python3 unzip xz-utils \
            zstd rsync ca-certificates wget \
            pahole dwarves zip

          # å®‰è£…æ›´æ–°çš„GCCä»¥æ»¡è¶³å†…æ ¸ç‰ˆæœ¬è¦æ±‚
          sudo apt-get install -y gcc-9 g++-9
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 90
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 90
          # éªŒè¯GCCç‰ˆæœ¬
          gcc --version

      - name: Setup directory structure
        run: |
          # åˆ›å»ºä¸Žæœ¬åœ°ä¸€è‡´çš„ç›®å½•ç»“æž„
          mkdir -p $GITHUB_WORKSPACE/kernel/toolchains
          mkdir -p $GITHUB_WORKSPACE/kernel/source
          mkdir -p $GITHUB_WORKSPACE/kernel/anykernel3
          mkdir -p $GITHUB_WORKSPACE/kernel/output

          echo "=== Created directory structure ==="
          ls -la $GITHUB_WORKSPACE/kernel/

      - name: Setup toolchains
        run: |
          cd $GITHUB_WORKSPACE/kernel

          echo "=== ä¸‹è½½ ARM GCC å·¥å…·é“¾ ==="
          # ä¸‹è½½ARM GCCå·¥å…·é“¾
          git clone --depth=1 \
            https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9.git \
            ./toolchains/gcc-arm-4.9

          echo "=== ä¸‹è½½ Clang å·¥å…·é“¾ ==="
          # åˆ›å»º Clang ç›®å½•
          mkdir -p ./toolchains/clang-14

          # ä¸‹è½½ Clang å·¥å…·é“¾
          cd toolchains
          wget -q https://github.com/ZyCromerZ/Clang/releases/download/14.0.6-20240212-release/Clang-14.0.6-20240212.tar.gz

          # æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
          if [ ! -f "Clang-14.0.6-20240212.tar.gz" ]; then
              echo "Error: Clang å·¥å…·é“¾ä¸‹è½½å¤±è´¥"
              exit 1
          fi

          echo "=== è§£åŽ‹ Clang å·¥å…·é“¾ ==="
          # è§£åŽ‹åˆ° clang-14 ç›®å½•
          tar -xzf Clang-14.0.6-20240212.tar.gz -C clang-14

          # æ£€æŸ¥è§£åŽ‹åŽçš„ç›®å½•ç»“æž„
          echo "=== æ£€æŸ¥è§£åŽ‹åŽçš„ç›®å½•ç»“æž„ ==="
          ls -la clang-14/

          # å¦‚æžœå­˜åœ¨åµŒå¥—ç›®å½•ï¼Œéœ€è¦è°ƒæ•´
          if [ -d "clang-14/Clang-14.0.6-20240212" ]; then
              echo "æ£€æµ‹åˆ°åµŒå¥—ç›®å½•ï¼Œæ­£åœ¨è°ƒæ•´..."
              mv clang-14/Clang-14.0.6-20240212/* clang-14/
              rmdir clang-14/Clang-14.0.6-20240212
          fi

          # æ¸…ç†ä¸‹è½½çš„åŽ‹ç¼©åŒ…
          rm -f Clang-14.0.6-20240212.tar.gz

          # è¿”å›ž kernel ç›®å½•
          cd $GITHUB_WORKSPACE/kernel

          echo "=== éªŒè¯å·¥å…·é“¾äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          # éªŒè¯å…³é”®å·¥å…·å­˜åœ¨
          echo "æ£€æŸ¥ Clang äºŒè¿›åˆ¶æ–‡ä»¶..."
          if [ -f "./toolchains/clang-14/bin/clang" ]; then
              echo "âœ“ clang å­˜åœ¨"
              ls -la ./toolchains/clang-14/bin/clang
          else
              echo "âœ— clang ä¸å­˜åœ¨ï¼Œæ£€æŸ¥ç›®å½•ç»“æž„:"
              find ./toolchains/clang-14 -name "clang" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° clang äºŒè¿›åˆ¶æ–‡ä»¶"
              exit 1
          fi

          echo "æ£€æŸ¥ aarch64-linux-gnu å·¥å…·..."
          if ls ./toolchains/clang-14/bin/aarch64-linux-gnu-* 1> /dev/null 2>&1; then
              echo "âœ“ aarch64-linux-gnu å·¥å…·å­˜åœ¨"
              ls -la ./toolchains/clang-14/bin/aarch64-linux-gnu-* | head -3
          else
              echo "âœ— aarch64-linux-gnu å·¥å…·ä¸å­˜åœ¨"
          fi

          echo "æ£€æŸ¥ LLVM å·¥å…·..."
          if ls ./toolchains/clang-14/bin/llvm-* 1> /dev/null 2>&1; then
              echo "âœ“ LLVM å·¥å…·å­˜åœ¨"
              ls -la ./toolchains/clang-14/bin/llvm-* | head -3
          else
              echo "âœ— LLVM å·¥å…·ä¸å­˜åœ¨"
          fi

          echo "æ£€æŸ¥ ARM GCC å·¥å…·..."
          if ls ./toolchains/gcc-arm-4.9/bin/arm-linux-androideabi-* 1> /dev/null 2>&1; then
              echo "âœ“ ARM GCC å·¥å…·å­˜åœ¨"
              ls -la ./toolchains/gcc-arm-4.9/bin/arm-linux-androideabi-* | head -3
          else
              echo "âœ— ARM GCC å·¥å…·ä¸å­˜åœ¨"
          fi

          echo "=== æœ€ç»ˆç›®å½•ç»“æž„ ==="
          echo "kernel/"
          ls -la ./
          echo "kernel/toolchains/"
          ls -la ./toolchains/
          echo "å·¥å…·é“¾è®¾ç½®å®Œæˆ ==="

      - name: Clone kernel source
        run: |
          cd $GITHUB_WORKSPACE/kernel
          git clone --depth=1 \
            https://github.com/crdroidandroid/android_kernel_oneplus_sm8650.git \
            ./source/android_kernel_oneplus_sm8650

          echo "=== å†…æ ¸æºç ç›®å½•ç»“æž„ ==="
          echo "kernel/source/"
          ls -la ./source/

      - name: Clone AnyKernel3
        run: |
          cd $GITHUB_WORKSPACE/kernel
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ./anykernel3

          echo "=== AnyKernel3 ç›®å½•ç»“æž„ ==="
          ls -la ./anykernel3/

      - name: Copy config to kernel source
        run: |
          cd $GITHUB_WORKSPACE/kernel
          if [ -f "$GITHUB_WORKSPACE/config" ]; then
            cp $GITHUB_WORKSPACE/config ./source/android_kernel_oneplus_sm8650/myconfig
            echo "Custom config copied"
          else
            echo "Error: config file not found!"
            exit 1
          fi

      - name: Copy and configure kernel config
        run: |
          cd $GITHUB_WORKSPACE/kernel
          if [ -f "$GITHUB_WORKSPACE/config" ]; then
            cp $GITHUB_WORKSPACE/config ./source/android_kernel_oneplus_sm8650/myconfig
          else
            echo "Error: config file not found!"
            exit 1
          fi

          cd source/android_kernel_oneplus_sm8650

          # Configure BBR if enabled
          if [ "${{ inputs.enable_bbr }}" = "true" ]; then
            echo "=== Enabling BBR TCP Congestion Control ==="
            cat >> myconfig << EOF

          # BBR TCP Congestion Control
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_DEFAULT_TCP_CONG="bbr"
          CONFIG_DEFAULT_BBR=y
          # CONFIG_DEFAULT_CUBIC is not set
          # CONFIG_DEFAULT_RENO is not set
          EOF
          fi

          # Configure ZRAM if enabled
          if [ "${{ inputs.enable_zram }}" = "true" ]; then
            echo "=== Enabling ZRAM with ${{ inputs.zram_algorithm }} compression ==="
            cat >> myconfig << EOF

          # ZRAM Support
          CONFIG_ZRAM=y
          CONFIG_ZRAM_DEF_COMP_LZ4=y
          CONFIG_ZRAM_WRITEBACK=y
          CONFIG_ZRAM_MEMORY_TRACKING=y
          CONFIG_ZSMALLOC=y
          CONFIG_ZSMALLOC_STAT=y
          EOF

            # Configure compression algorithm
            if [ "${{ inputs.zram_algorithm }}" = "zstd" ]; then
              cat >> myconfig << EOF
          CONFIG_CRYPTO_ZSTD=y
          CONFIG_ZRAM_DEF_COMP="zstd"
          CONFIG_ZRAM_DEF_COMP_ZSTD=y
          # CONFIG_ZRAM_DEF_COMP_LZ4 is not set
          EOF
            else
              cat >> myconfig << EOF
          CONFIG_CRYPTO_LZ4=y
          CONFIG_CRYPTO_LZ4HC=y
          CONFIG_ZRAM_DEF_COMP="lz4"
          CONFIG_ZRAM_DEF_COMP_LZ4=y
          EOF
            fi
          fi

          echo "=== Configuration Summary ==="
          echo "BBR Enabled: ${{ inputs.enable_bbr }}"
          echo "ZRAM Enabled: ${{ inputs.enable_zram }}"
          echo "ZRAM Algorithm: ${{ inputs.zram_algorithm }}"

      - name: Install root solution
        run: |
          cd $GITHUB_WORKSPACE/kernel/source/android_kernel_oneplus_sm8650
          export KCONFIG_CONFIG=myconfig

          echo "ðŸ‘‰ é€‰æ‹©çš„ Root æ–¹æ¡ˆï¼š${{ github.event.inputs.root_solution }}"
          if [ "${{ github.event.inputs.root_solution }}" = "kernelsu" ]; then
            echo "âœ… é›†æˆ KernelSU"
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          elif [ "${{ github.event.inputs.root_solution }}" = "kernelsu-next" ]; then
            echo "âœ… é›†æˆ KernelSU-Next"
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
          elif [ "${{ github.event.inputs.root_solution }}" = "sukisu" ]; then
            echo "âœ… é›†æˆ SukiSU-Ultra"
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          elif [ "${{ github.event.inputs.root_solution }}" = "none" ]; then
          echo "â„¹ï¸ æœªé€‰æ‹©ä»»ä½• Root æ–¹æ¡ˆï¼Œè·³è¿‡"
          else
            echo "âŒ æœªçŸ¥çš„ root_solution: ${{ github.event.inputs.root_solution }}"
            exit 1
          fi

      - name: Build kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel/source/android_kernel_oneplus_sm8650

          # è®°å½•å¼€å§‹æ—¶é—´
          starttime=$(date +'%Y-%m-%d %H:%M:%S')
          echo "Build started at: $starttime"

          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export ARCH=arm64
          export SUBARCH=arm64
          export KCONFIG_CONFIG=$PWD/myconfig

          # è®¾ç½®å·¥å…·é“¾è·¯å¾„å˜é‡
          CLANG_PATH=$GITHUB_WORKSPACE/kernel/toolchains/clang-14/bin
          GCC_ARM_PATH=$GITHUB_WORKSPACE/kernel/toolchains/gcc-arm-4.9/bin

          # éªŒè¯æ‰€æœ‰å¿…éœ€çš„å·¥å…·
          echo "=== Verifying required tools ==="
          $CLANG_PATH/clang --version | head -2
          $CLANG_PATH/aarch64-linux-gnu-gcc --version | head -1 || echo "aarch64-linux-gnu-gcc not found"
          $GCC_ARM_PATH/arm-linux-androideabi-gcc --version | head -1
          test -f $CLANG_PATH/ld.lld && echo "ld.lld found" || echo "ld.lld not found"
          gcc --version | head -1
          echo "================================"

          # æ¸…ç†æž„å»ºç›®å½•
          rm -rf out
          mkdir -p out

          # ç”Ÿæˆé»˜è®¤é…ç½®
          make O=out KCONFIG_CONFIG=$KCONFIG_CONFIG olddefconfig

          # ç¼–è¯‘å†…æ ¸
          make -j$(nproc) O=out WERROR=0 \
              KCFLAGS="-Wno-error=frame-larger-than= -O3 -pipe" \
              KCPPFLAGS="-DCONFIG_CC_OPTIMIZE_FOR_PERFORMANCE" \
              HOSTCFLAGS="-O3 -pipe" \
              HOSTCXXFLAGS="-O3 -pipe" \
              NM=$CLANG_PATH/llvm-nm \
              OBJCOPY=$CLANG_PATH/llvm-objcopy \
              LD=$CLANG_PATH/ld.lld \
              CROSS_COMPILE=$CLANG_PATH/aarch64-linux-gnu- \
              CROSS_COMPILE_ARM32=$GCC_ARM_PATH/arm-linux-androideabi- \
              CC=$CLANG_PATH/clang \
              AR=$CLANG_PATH/llvm-ar \
              OBJDUMP=$CLANG_PATH/llvm-objdump \
              STRIP=$CLANG_PATH/llvm-strip \
              2>&1 | tee out/error.log

          # è®°å½•ç»“æŸæ—¶é—´
          endtime=$(date +'%Y-%m-%d %H:%M:%S')
          echo "Build finished at: $endtime"

      - name: Check build results
        run: |
          cd $GITHUB_WORKSPACE/kernel/source/android_kernel_oneplus_sm8650
          echo "=== Build Results ==="
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "âœ… Kernel build successful!"
            ls -la out/arch/arm64/boot/
            echo "Image size: $(du -h out/arch/arm64/boot/Image)" 
          else
            echo "âŒ Kernel build failed!"
            echo "=== Last 100 lines of error log ==="
            tail -100 out/error.log
            echo "=== Error summary ==="
            grep -i "error\|failed\|stop" out/error.log | tail -10
            exit 1
          fi

      - name: Prepare AnyKernel3 package
        run: |
          cd $GITHUB_WORKSPACE/kernel

          # è®¾ç½®å†…æ ¸åç§°
          KERNEL_NAME="${{ inputs.kernel_name }}"
          if [ -z "$KERNEL_NAME" ]; then
            KERNEL_NAME="CustomKernel"
          fi

          # èŽ·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          cd source/android_kernel_oneplus_sm8650
          KERNEL_VERSION=$(make kernelversion 2>/dev/null || echo "unknown")
          BUILD_DATE=$(date +'%Y%m%d_%H%M')

          cd $GITHUB_WORKSPACE/kernel

          echo "=== å‡†å¤‡ AnyKernel3 æ‰“åŒ… ==="
          echo "å†…æ ¸åç§°: $KERNEL_NAME"
          echo "å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
          echo "æž„å»ºæ—¥æœŸ: $BUILD_DATE"

          # å¤åˆ¶ AnyKernel3 æ¨¡æ¿åˆ°è¾“å‡ºç›®å½•
          cp -r anykernel3/* output/

          # å¤åˆ¶å†…æ ¸æ–‡ä»¶
          cp source/android_kernel_oneplus_sm8650/out/arch/arm64/boot/Image output/

          # ä¿®æ”¹ AnyKernel3 é…ç½®
          cd output
          rm -rf ramdisk patch modules

          # å¤‡ä»½åŽŸå§‹ anykernel.sh
          cp anykernel.sh anykernel.sh.bak

          # è‡ªå®šä¹‰ anykernel.sh é…ç½®
          cat > anykernel.sh << 'EOF'           
          ### AnyKernel3 Ramdisk Mod Script
          ## osm0sis @ xda-developers

          ### AnyKernel setup
          # global properties
          properties() { '
          kernel.string=Wild Plus Kernel by TheWildJames or Morgan Weedman
          do.devicecheck=0
          do.modules=0
          do.systemless=0
          do.cleanup=1
          do.cleanuponabort=0
          device.name1=corvette
          device.name2=PJX110
          device.name3=
          device.name4=
          device.name5=
          supported.versions=
          supported.patchlevels=
          supported.vendorpatchlevels=
          '; } # end properties

          ### AnyKernel install
          ## boot shell variables
          block=boot
          is_slot_device=auto
          ramdisk_compression=auto
          patch_vbmeta_flag=auto
          no_magisk_check=1

          # import functions/variables and setup patching - see for reference (DO NOT REMOVE)
          . tools/ak3-core.sh

          kernel_version=$(cat /proc/version | awk -F '-' '{print $1}' | awk '{print $3}')
          case $kernel_version in
          5.1*) ksu_supported=true ;;
          6.1*) ksu_supported=true ;;
          6.6*) ksu_supported=true ;;
          *) ksu_supported=false ;;
          esac

          ui_print " " "  -> ksu_supported: $ksu_supported"
          $ksu_supported || abort "  -> Non-GKI device, abort."

          # boot install
          if [ -L "/dev/block/bootdevice/by-name/init_boot_a" -o -L "/dev/block/by-name/init_boot_a" ]; then
            split_boot # for devices with init_boot ramdisk
            flash_boot # for devices with init_boot ramdisk
          else
            dump_boot  # use split_boot to skip ramdisk unpack, e.g. for devices with init_boot ramdisk
            write_boot # use flash_boot to skip ramdisk repack, e.g. for devices with init_boot ramdisk
          fi
          ## end boot install
          EOF

          # åˆ›å»ºæ›´æ–°ä¿¡æ¯æ–‡ä»¶
          cat > kernel_info.txt << EOF
          Kernel Name: $KERNEL_NAME
          Kernel Version: $KERNEL_VERSION
          Build Date: $BUILD_DATE
          BBR Enabled: ${{ inputs.enable_bbr }}
          Compiler: Clang 14.0.6
          Target Device: OnePlus ACE3 Pro(SM8650)
          Architecture: ARM64
          EOF

          echo "=== AnyKernel3 å‡†å¤‡å®Œæˆ ==="
          ls -la ./

      - name: Create AnyKernel3 ZIP package
        run: |
          cd $GITHUB_WORKSPACE/kernel/output

          # è®¾ç½®åŒ…å
          KERNEL_NAME="${{ inputs.kernel_name }}"
          if [ -z "$KERNEL_NAME" ]; then
            KERNEL_NAME="CustomKernel"
          fi

          BUILD_DATE=$(date +'%Y%m%d_%H%M')
          BBR_SUFFIX=""
          if [ "${{ inputs.enable_bbr }}" = "true" ]; then
            BBR_SUFFIX="_BBR"
          fi

          ZIP_NAME="${KERNEL_NAME}${BBR_SUFFIX}_${BUILD_DATE}.zip"

          echo "=== åˆ›å»º ZIP åŒ…: $ZIP_NAME ==="

          # åˆ›å»º ZIP åŒ…
          zip -r9 "$ZIP_NAME" . -x "*.bak" "*.zip"

          # éªŒè¯ ZIP åŒ…
          if [ -f "$ZIP_NAME" ]; then
            echo "âœ… ZIP åŒ…åˆ›å»ºæˆåŠŸ!"
            echo "åŒ…å: $ZIP_NAME"
            echo "å¤§å°: $(du -h "$ZIP_NAME")"
            
            # æ˜¾ç¤º ZIP åŒ…å†…å®¹
            echo "=== ZIP åŒ…å†…å®¹ ==="
            unzip -l "$ZIP_NAME" | head -20
          else
            echo "âŒ ZIP åŒ…åˆ›å»ºå¤±è´¥!"
            exit 1
          fi

          # ä¿å­˜åŒ…åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-build-${{ github.run_number }}
          path: |
            kernel/source/android_kernel_oneplus_sm8650/out/arch/arm64/boot/Image*
            kernel/source/android_kernel_oneplus_sm8650/out/arch/arm64/boot/dts/*/*.dtb
            kernel/source/android_kernel_oneplus_sm8650/out/error.log
            kernel/source/android_kernel_oneplus_sm8650/out/.config
            kernel/output/*.zip
            kernel/output/kernel_info.txt

      - name: Upload AnyKernel3 ZIP
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ env.ZIP_NAME }}
          path: kernel/output/${{ env.ZIP_NAME }}
          retention-days: 25
